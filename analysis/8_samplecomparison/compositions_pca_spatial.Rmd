---
title: "Compositional distances (space)"
author: "Ricardo Ramirez"
date: "4/15/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Introduction

One way to compare single cell samples is using their compositional features. In other words, the feature space of each sample is the cell proportions of each cell-type.

Compositional data is relatively difficult to analyze because proportions are not independent. The space generated by these features is suboptimal for usual analysis such as PCA and linear models.

One option to analyze compositional data is using log-ratio transformations, that allow to send the data into a format suitable for regular statistical analysis

```{r setup, include=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(philentropy)
library(compositions)
```

## Analyzing compositions from a single cell atlas

First load all of the data and visualize the proportions

```{r}
# Get all data files -----------------------------------------------------------------------
slide_files_folder <- "./visium_results_manuscript/processed_visium_revisions/"
slide_files <- list.files(slide_files_folder)
slide_files_full <- paste0(slide_files_folder, 
                           slide_files)
slide_ids <- gsub("[.]rds", "", slide_files)

# Patient annotation -------------------------------------------------------------------------
condition_dictionary <- read.table("./markers/NEW_PatIDs_visium_overview_allsamples.tsv",
                                   sep = "\t", header = T) %>%
  mutate_all(as.character) %>%
  dplyr::select(Visium, New.Ids) %>%
  dplyr::rename(slide = Visium,
                patient = New.Ids)

# celltype v cell-states dictionary -------------
cell_dictionary <- readRDS("visium_results_manuscript/integration/ps_integrated_data_fordeconv.rds")[[1]][["annotations"]] %>%
  dplyr::mutate(deconv_col = gsub("_","-", deconv_col)) %>%
  dplyr::select(cell_type, deconv_col) %>%
  unique() %>%
  #dplyr::mutate(cell_type = ifelse(deconv_col == "VSMCs",
  #                                 "VSMCs", cell_type)) %>%
  dplyr::rename(mjr_ct = cell_type,
                cell_type = deconv_col)
```

```{r}
deconv_res <- tibble("slide_path" = slide_files_full,
                     "slide" = slide_ids) %>%
  dplyr::mutate(deconv_mats = map(slide_path, function(x) {
    
    slide_obj <- readRDS(x)
    
    list("cell2location" = as.matrix(slide_obj[["c2l"]]@data) %>%
             as.data.frame() %>%
             rownames_to_column("cell_type") %>%
             pivot_longer(-cell_type),
           "cell2location_states" = as.matrix(slide_obj[["c2l_statesred"]]@data) %>%
             as.data.frame() %>%
             rownames_to_column("cell_type") %>%
             pivot_longer(-cell_type))
    
    
  }))

# Here I keep in long format for further filtering ----------

deconv_res <- deconv_res %>% 
  dplyr::select(slide, deconv_mats) %>%
  dplyr::mutate(cell2location_states = map(deconv_mats, ~ .x[["cell2location_states"]]),
                cell2location = map(deconv_mats, ~ .x[["cell2location"]])) %>%
  dplyr::select(slide, cell2location_states)  %>%
  dplyr::left_join(condition_dictionary) %>% 
  unnest() %>%
  dplyr::rename(.,c2l_value = value)

# Here we identify spots that contain 0 cells

spot_dict <- deconv_res %>%
  group_by(slide, name) %>%
  summarize(spot_cells =  sum(c2l_value))

deconv_res <- deconv_res %>%
  left_join(spot_dict, by  = c("slide", "name")) %>%
  dplyr::filter(spot_cells >= 1)

# Here I transform c2l scores to proportions ----------------------------------------
deconv_res <- deconv_res %>%
  group_by(patient, name) %>%
  dplyr::mutate(c2l_prop = c2l_value/(sum(c2l_value))) %>%
  ungroup()

slide_cell_count <- deconv_res %>%
  group_by(patient, cell_type) %>%
  summarise(c2l_cell_n = sum(c2l_value)) %>%
  ungroup() %>% 
  group_by(patient) %>%
  mutate(c2l_slide_count = sum(c2l_cell_n)) %>%
  mutate(c2l_cell_prop = c2l_cell_n/c2l_slide_count) %>%
  unique()
```

Grouping by major cell types

```{r}
ct_props_grouped <- slide_cell_count %>% 
  left_join(cell_dictionary) %>%
  group_by(patient, mjr_ct) %>%
  summarise(mjr_cell_n = sum(c2l_cell_n),
            mjr_sell_prop = sum(c2l_cell_prop))
```

```{r}
ct_props_grouped %>%
  ggplot(aes(x = mjr_cell_n,
           y = patient,
           fill = mjr_ct)) + 
  geom_bar(position="fill", 
           stat="identity") +
  theme(legend.position = "bottom") +
  ylab("") + xlab("n_cells")  
```

### How similar are the cell-type compositions between patients?

First lets ensure that all proportions are complete. This means that the sum of all compositions equal to 1 per sample.

In this case we have 7 samples and 9 cell-types

```{r}
cell_props <- ct_props_grouped %>%
  dplyr::select(patient, mjr_ct, mjr_sell_prop) %>%
  pivot_wider(values_from = mjr_sell_prop,
              names_from = mjr_ct) %>%
  column_to_rownames(var = "patient") %>%
  acomp() %>%
  as.data.frame()

head(cell_props)

dim(cell_props)
```

Then let's transform this data using isometric log ratios:

1) Get the transformation base

Each of the columns represents the weights of the orthonormal basis. This basis is formed by cell_types-1, since you only need n-1 elements to build ratios. (eg, you always know the last element of a series of proportions since everything must sum 1)

```{r}
baseILR <- ilrBase(x=cell_props,
                  method = "basic")

head(baseILR)
```

Let's not think too much on the weights now but check the appendix if interested

```{r}
#ILR transformation
cell_ilr <- as.matrix(ilr(as.matrix(cell_props), baseILR))
colnames(cell_ilr) <- paste0("ILR_", 1:ncol(cell_ilr))
cell_ilr
```

This features capture all the information of compositions in an orthonormal space that allow us to do regular analysis.

### PCA

For this project I am interested in knowing which patients look similar when looking only at compositions

```{r}
ilr_pcs <- prcomp(x = cell_ilr)
ilr_pcs <- ilr_pcs$x %>%
  as.data.frame() %>%
  rownames_to_column("patient")
```

Adding annotations

```{r}
sample_dict <- read.table("./markers/NEW_PatIDs_visium_overview_allsamples.tsv",
                                   sep = "\t", header = T) %>%
  mutate_all(as.character) %>%
  dplyr::select(Visium, New.Ids) %>%
  dplyr::rename(orig.ident = Visium,
                patient_sample = New.Ids) %>%
  dplyr::mutate(patientid = map_chr(strsplit(patient_sample, "_"), 
                                  ~.x[[1]]),
                area = map_chr(strsplit(patient_sample, "_"), 
                               ~.x[[2]]))
```

```{r}
sample_dict
```

```{r}
ilr_pcs %>%
  left_join(sample_dict, by = c("patient" = "patient_sample")) %>%
  ggplot(aes(x = PC1, y = PC2, 
             color = area, 
             label = patientid)) +
      geom_point(size = 1) +
      ggrepel::geom_text_repel() +
      theme_classic()
```