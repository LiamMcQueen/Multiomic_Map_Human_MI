---
title: "Structural differences"
author: "Ricardo Ramirez"
date: "9/8/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(cowplot)
library(mistyR)
library(uwot)
```

## Introduction

Can we explain the differences of phenotypes using cell-cell interactions?

The assumption is that the compositional differences observed at the single cell level should in one way or another affect the way cells organize and generate structures

First we recover the importances 

```{r message=F, warning=F}
misty_out_folder <- "./results/tissue_structure/misty/cell_map/"
misty_outs <- list.files(misty_out_folder, full.names = F)
misty_outs <- set_names(misty_outs, gsub("cm_", "", misty_outs) %>%
                          gsub("_c2l", "", .))

sample_dict <- readRDS("./markers/visium_patient_anns_revisions.rds")

# Here we will extract the importances of all views in all samples
sample_importances <- map(misty_outs, function(x) {
  misty_res <- collect_results(paste0(misty_out_folder, x))[["importances.aggregated"]]
})

sample_importances <- sample_importances %>% 
  enframe() %>% 
  unnest() %>%
  na.omit() %>%
  left_join(sample_dict, by = c("name" = "sample_id"))
```

# RUN PCA + UMAP on importances

```{r}
sample_importances_mat <- sample_importances %>%
  #dplyr::filter(view == "intra") %>%
  dplyr::mutate(int_id = paste0(view,"..",Predictor,"_to_",Target)) %>%
  dplyr::select(name, int_id, Importance) %>%
  pivot_wider(names_from = int_id, values_from = Importance) %>%
  column_to_rownames("name") %>%
  as.matrix()
```

We perform a PCA on the scaled importances

```{r}
ilr_pcs_res <- prcomp(x = sample_importances_mat)
ilr_pcs <- ilr_pcs_res$x %>%
  as.data.frame() %>%
  rownames_to_column("orig.ident")
```

```{r}
ilr_pcs %>%
left_join(sample_dict, by = c("orig.ident" = "sample_id")) %>%
  ggplot(aes(x = PC1, y = PC2, 
             color = patient_group, 
             label = patient_id)) +
      geom_point(size = 1) +
      ggrepel::geom_text_repel() +
      theme_classic()
```

This projection is misleading, since it only takes into account the first 2 PCs aprox 12%

```{r}
prop_sd = ilr_pcs_res$sdev/sum(ilr_pcs_res$sdev)
PC_label = paste0("PC_", seq(1,length(ilr_pcs_res$sdev),1))

tibble("prop_sd" = prop_sd,
       "PC" = PC_label) %>%
  ggplot(aes(x = factor(PC,
                        levels = PC_label), 
             y = prop_sd)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90))

```

## UMAP of samples

Finally, we project the pseudobulk profiles in the UMAP and define three groups of patients from the hierarchical clustering of the expression profiles of all samples

```{r}
gex_umap <- umap(sample_importances_mat, 
                 n_neighbors = 5, 
                 n_epochs = 1000,
                 metric = "cosine") %>%
  as.data.frame() %>%
  mutate(orig.ident = rownames(sample_importances_mat))
```

```{r, fig.height=5, fig.width=7}
umap_plt <- gex_umap %>%
  left_join(sample_dict, by = c("orig.ident" = "sample_id")) %>%
  ggplot(aes(x = V1, y = V2, 
             color = patient_group, 
             label = patient_id)) +
      geom_point(size = 1) +
      ggrepel::geom_text_repel() +
      theme_classic() +
  xlab("UMAP1") +
  ylab("UMAP2")

plot(umap_plt)
```

```{r}
pdf("./results/sample_comparison/spatial/misty_importances_umap.pdf",width = 5, height = 4.5)
plot(umap_plt)
dev.off()
```

Then we test the importances that are higher in one group vs the other:
We are correcting first by cell-cell importance 

```{r, warning=F}
run_wilcox_all <- function(prop_data) {
  
  prop_data_group <- prop_data[["patient_group"]] %>%
    unique() %>%
    set_names()
  
  map(prop_data_group, function(g) {
    
    test_data <- prop_data %>%
      mutate(test_group = ifelse(patient_group == g,
                                 "target", "rest")) %>%
      mutate(test_group = factor(test_group,
                                 levels = c("target", "rest")))
    
    wilcox.test(Importance ~ test_group, 
                data = test_data,
                alternative = "greater") %>%
      broom::tidy()
  }) %>% enframe("patient_group") %>%
    unnest()
  
}

# Here we identify interactions that are important ( > 0, > 1)
# Then test in which patient group they are larger
cell_interaction_comp <- sample_importances %>%
  group_by(view, Predictor, Target) %>%
  nest() %>%
  mutate(max_median_imp = map(data, function(dat) {
    
    dat %>% 
      group_by(patient_group) %>%
      summarize(med_importance = median(Importance)) %>%
      dplyr::filter(med_importance == max(med_importance)) %>%
      pull(med_importance)
    
  })) %>%
  unnest(max_median_imp) %>%
  dplyr::filter(max_median_imp >= 1) %>%
  mutate(wres = map(data, run_wilcox_all)) %>%
  #select(wres) %>%
  unnest(wres) %>%
  ungroup() %>%
  group_by(view, Predictor) %>%
  mutate(corr_pval = p.adjust(p.value)) %>%
  ungroup()
  
```

```{r}
all_sign_ints <- cell_interaction_comp %>%
  dplyr::mutate(changing_int = ifelse(corr_pval <= 0.25, TRUE, FALSE)) %>%
  group_by(Predictor, Target) %>%
  dplyr::mutate(n_sign = sum(changing_int)) %>%
  dplyr::filter(n_sign > 0) %>%
  ungroup() %>%
  dplyr::mutate(int_id = paste0(Predictor, "_to_", Target)) %>%
  dplyr::select(view, data, Predictor, Target, patient_group, corr_pval, int_id) %>%
  mutate(pval_text = ifelse(corr_pval <= 0.25, "*", ""))

all_sign_ints <- cell_interaction_comp %>%
  dplyr::filter(corr_pval <= 0.25) %>%
  ungroup() %>%
  dplyr::mutate(int_id = paste0(Predictor, "_to_", Target)) %>%
  dplyr::select(view, data, Predictor, Target, patient_group, corr_pval, int_id) %>%
  mutate(pval_text = ifelse(corr_pval <= 0.25, "*", ""))

max_importance <- all_sign_ints %>%
  dplyr::select(view, data, Predictor, Target) %>%
  unique() %>%
  mutate(max_median_imp = map(data, function(dat) {
    
    dat %>% 
      group_by(patient_group) %>%
      summarize(med_importance = median(Importance)) %>%
      dplyr::filter(med_importance == max(med_importance)) %>%
      pull(med_importance)
    
  })) %>%
  unnest(max_median_imp) %>%
  dplyr::select(-data)

all_sign_ints <- all_sign_ints %>%
  left_join(max_importance, by = c("view", "Predictor", "Target")) %>%
  group_by(Predictor, Target) %>%
  mutate(ref_imp = max(max_median_imp)) %>%
  dplyr::filter(ref_imp > 0)

lab_order <- all_sign_ints %>%
  arrange(patient_group, int_id) %>%
  pull(int_id) %>% unique()

write.table(all_sign_ints %>%
              dplyr::select(-data),
            "./results/sample_comparison/spatial/sign_interaction_changes.txt", 
            sep = "\t",col.names = T, row.names = F, quote = F)
```

```{r, fig.height=5, fig.width=5}
imprt_plot <- all_sign_ints %>%
  dplyr::select(-data) %>%
  mutate(int_id = factor(int_id,
                         levels = lab_order)) %>%
  #complete(view, int_id, patient_group) %>%
  ggplot(., aes(x = patient_group, 
                          y = int_id, 
                          fill = -log10(corr_pval))) +
  geom_tile() +
  geom_text(aes(label=pval_text)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.background = element_rect(fill="white", colour='black',
                                        size=1)) +
  facet_wrap(.~view, ncol = 3) +
  ylab("Model interaction") +
  scale_fill_gradient(na.value = "white")

plot(imprt_plot)
```

```{r}
pdf("./results/sample_comparison/spatial/sign_interaction_changes.pdf", height = 5, width = 5)
plot(imprt_plot)
dev.off()
```

```{r}
all_sign_ints %>%
  dplyr::filter(int_id == "Endo_to_CM") %>%
  dplyr::select(view, data, Predictor, Target) %>%
  unique() %>%
  unnest() %>%
  ggplot(aes(x = patient_group, 
             y = Importance)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_wrap(.~view, ncol = 3)
```

