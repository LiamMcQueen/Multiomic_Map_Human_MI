---
title: "Comparing compositions between technologies"
author: "Ricardo Ramirez"
date: "4/16/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

To evaluate if there are differences betweeen cell compositions estimated from independent technologies, we performe a simple correlation between snuc, visium, and atac.

```{r setup, include=FALSE}
library(tidyverse)
library(Seurat)
```

## Spatial

First get all the slide files that should contain and assay inside them with cell2location cell  scores in the `c2l` assay

```{r}
# Get all data files -----------------------------------------------------------------------
slide_files_folder <- "./visium_results_manuscript/deconvolution/c2l_statescollapsed/location_models/density_tables_rds/"
slide_files <- list.files(slide_files_folder)
slide_files_full <- paste0(slide_files_folder, 
                           slide_files)
slide_ids <- gsub("[.]rds", "", slide_files)

# Patient annotation -------------------------------------------------------------------------
condition_dictionary <- read.table("./markers/NEW_PatIDs_visium_overview_allsamples.tsv",
                                   sep = "\t", header = T) %>%
  mutate_all(as.character) %>%
  dplyr::select(Visium, New.Ids, snRNA) %>%
  dplyr::rename(slide = Visium,
                scell = snRNA,
                patient = New.Ids)
```

I extract cell2location cell count matrices from visium processed data.

```{r}
deconv_res<- tibble("slide_path" = slide_files_full,
                     "slide" = slide_ids) %>%
  dplyr::mutate(deconv_mats = map(slide_path, ~ readRDS(.x) %>%
                                    as.data.frame() %>%
                                    rownames_to_column("spot_id") %>%
                                    pivot_longer(-spot_id, 
                                                 names_to = "cell_type",
                                                 values_to = "c2l_value"))) %>%
  dplyr::select(-slide_path) %>%
  left_join(condition_dictionary) %>%
  unnest()
```

Then we filter all location scores that repreesent less than 1 cell per spot given our priors

```{r}
# prior from nuclei quantification
max_n_cells_spot <- 5
value_cutoff <- 1/max_n_cells_spot

deconv_res <- deconv_res %>%
  group_by(slide, spot_id) %>%
  mutate(n_cells_spot =  sum(c2l_value)) %>%
  mutate(c2l_value_prop = c2l_value / n_cells_spot) %>%
  dplyr::filter(n_cells_spot > 0) %>%
  #dplyr::filter(c2l_value_prop >= value_cutoff) %>%
  ungroup()
```

Per slide we will quantify number of cells and final proportions

```{r}
spatial_props <- deconv_res %>%
  group_by(patient, cell_type) %>%
  summarize(sp_n_cells = sum(c2l_value)) %>%
  ungroup() %>%
  group_by(patient) %>%
  mutate(sp_prop_cells = sp_n_cells/sum(sp_n_cells))
```

## Single nuc data

```{r}
# Scell data meta --------------------------------------------------------------------------
scell_meta <- readRDS("visium_results_manuscript/integration/ps_integrated_data_fordeconv.rds")[[1]][["annotations"]]

# Generate cell type counts -----------------------------------------------------------
scell_props <- scell_meta %>%
  group_by(orig.ident, deconv_col) %>%
  summarize(sn_n_cells = length(orig.ident)) %>%
  mutate(sn_prop_cells = sn_n_cells/sum(sn_n_cells)) %>%
  dplyr::rename(scell = orig.ident,
                cell_type = deconv_col) %>%
  left_join(condition_dictionary)
```

## Comparisons

```{r}
all_props <- left_join(spatial_props, scell_props,
                       by = c("cell_type", "patient"))
```

### Correlations

Let's correlate the states, these are in theory very unstable, since states are continous. 

```{r}
ggplot(all_props, aes(x = log(sp_prop_cells),
                      y = log(sn_prop_cells),
                      color = cell_type)) +
  geom_point() +
  facet_wrap(.~patient)
```

```{r, warning = FALSE}
state_cors <- all_props %>%
  na.omit() %>%
  group_by(patient) %>%
  nest() %>%
  mutate(cor_res = map(data, function(x) {
    
    dat <- na.omit(x)
    broom::tidy(cor.test(log10(dat$sp_prop_cells), 
                         log10(dat$sn_prop_cells), 
                         method = "spearman"))
    
  })) %>%
  dplyr::select(patient, cor_res) %>%
  unnest() %>%
  ungroup() %>%
  mutate(cor.p.value= p.adjust(p.value))

print(state_cors)
```

What happens if we first group these annotations into major cells?

```{r}
cell_dictionary <- scell_meta %>%
  dplyr::select(cell_type, deconv_col) %>%
  unique() %>%
  dplyr::mutate(cell_type = ifelse(deconv_col == "VSMCs",
                                   "VSMCs", cell_type)) %>%
  dplyr::rename(mjr_ct = cell_type,
                cell_type = deconv_col)
```

```{r}
mjr_all_props <- all_props %>%
  left_join(cell_dictionary) %>%
  ungroup() %>%
  group_by(patient, mjr_ct) %>%
  summarise(sp_n_cells = sum(sp_n_cells),
            sp_prop_cells = sum(sp_prop_cells), 
            sn_n_cells = sum(sn_n_cells),
            sn_prop_cells = sum(sn_prop_cells))
```

```{r}
ggplot(mjr_all_props, aes(x = log(sp_prop_cells),
                      y = log(sn_prop_cells),
                      color = mjr_ct)) +
  geom_point() +
  facet_wrap(.~patient)
```

```{r, warning = FALSE}
state_cors <- mjr_all_props %>%
  na.omit() %>%
  group_by(patient) %>%
  nest() %>%
  mutate(cor_res = map(data, function(x) {
    
    dat <- na.omit(x)
    broom::tidy(cor.test(log10(dat$sp_prop_cells), 
                         log10(dat$sn_prop_cells), 
                         method = "spearman"))
    
  })) %>%
  dplyr::select(patient, cor_res) %>%
  unnest() %>%
  ungroup() %>%
  mutate(cor.p.value= p.adjust(p.value))

print(state_cors)
```

```{r}
sessionInfo()
```

