---
title: "What is inside the niches?"
author: "Ricardo Ramirez"
date: "5/4/2021"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

## Introduction

By performing an integration of spots of all slides, I aimed to define classes per spot that represent a niche (or cell community). My intuition is that spots that are similar share compositions or functions throughout samples. This comes from my assumption that the heart tissue is a mosaic and the idea is to identify the color and size of the tiles.


```{r setup, include=FALSE}
library(tidyverse)
library(Seurat)
library(ComplexHeatmap)
library(circlize)
library(compositions)
col_fun = colorRamp2(c(0, 1), c("black", "yellow"))
```

## Analyzing compositions from a single cell atlas

Load annotations of visium samples

```{r}
sample_dict <- read.table("./markers/visium_annotations_ext.txt", 
                          sep = "\t", header = T)
sample_dict
```

Load all of the data and visualize the proportions

```{r}
# Get atlas cell-info ------------------------------------------------------------------------------------
atlas_meta <- readRDS("./processed_visium/integration/ps_integrated_slides_niches.rds")[[1]][["annotations"]]

# Niche composition -----------------------------------
cell_info <- atlas_meta %>%
  dplyr::group_by(orig.ident, opt_clust_integrated) %>%
  summarize(ncells = length(opt_clust_integrated)) %>%
  dplyr::mutate(all_sample_cells = sum(ncells)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(cell_prop = ncells/all_sample_cells) %>%
  left_join(sample_dict, by = c("orig.ident" = "sample_id")) %>%
  mutate(niche = paste0("niche_", opt_clust_integrated))

# Niche composition in matrix
cell_props <- cell_info %>%
  dplyr::select(orig.ident, niche, cell_prop) %>%
  pivot_wider(values_from = cell_prop,
              names_from = niche) %>%
  column_to_rownames(var = "orig.ident") %>%
  acomp() %>%
  as.data.frame()

cell_props[is.na(cell_props)] <- 0

head(cell_props)
dim(cell_props)

# Sort them as in the meta-dictionary
cell_props <- cell_props[sample_dict$sample_id,]
rownames(cell_props) <- sample_dict$pid

#Not all niches are informative for patient comparison(these are structures that are specific to a patient, noise, etc)
# So let's cut all the niches that aren't particularly present in 5 samples (minimum patient group size)
niche_filter <- colSums(cell_props > 0.01) >= 5
cell_props <- cell_props[, niche_filter]
niche_filter <- colnames(cell_props)
```

## Filtering

First filter all niches that represent less than 1% and all the niches that aren't represented in at least 5 samples

```{r}
cell_info <- cell_info %>%
  dplyr::filter(cell_prop > 0.01,
                niche %in% niche_filter)

cell_info <- cell_info %>%
  dplyr::select(orig.ident, niche)
```

## Compositions of cell types within each niche

```{r}
visium_folder = "./processed_visium/objects/"

visium_files <- list.files(visium_folder, full.names = F)
visium_samples <- gsub("[.]rds", "", visium_files)

# This creates a vector of mean proportions of all spots belin
visium_df <- tibble(visium_file = paste0(visium_folder, 
                                         visium_files),
                    sample = visium_samples) %>%
  mutate(niche_ct_meanprops = map(visium_file, function(f_path) {
    
    visium_slide <- readRDS(f_path)
    Idents(visium_slide) <- "opt_clust_integrated"
    
    niche_cors <- map(set_names(levels(Idents(visium_slide))),
                      function(niche) {
                        
                        niche_cells <- WhichCells(visium_slide, idents = c(niche))
                        
                        prop_mat <- GetAssayData(visium_slide, 
                                                 assay = "c2l_props") %>%
                          as.matrix()
                        
                        prop_mat <- prop_mat[, niche_cells, drop = F] %>%
                          rowMeans()
                      })
    
  })) %>%
  unnest_longer("niche_ct_meanprops")

```


```{r}
visium_df <- visium_df %>%
  dplyr::select(sample, niche_ct_meanprops, niche_ct_meanprops_id) %>%
  mutate(niche_ct_meanprops = map(niche_ct_meanprops, function(x) {
    
    df_props <- x %>%
      as.data.frame()
    
    colnames(df_props) = "mean_prop"
    
    df_props %>% rownames_to_column("cell_type")
    
  })) %>% unnest()
```

Finally aligned with the data we had before

```{r}
cell_info <- cell_info %>%
  left_join(visium_df, by = c("orig.ident" = "sample",
                              "niche" = "niche_ct_meanprops_id"))

cell_info <- cell_info %>%
  dplyr::arrange(niche, orig.ident) %>%
  dplyr::mutate(pid = paste0(orig.ident, "_",niche))

pat_order <- cell_info$pid %>% unique()

```

### Plotting

```{r}
cell_info %>%
  ggplot(aes(x = cell_type, 
             y = factor(pid,
                        levels = pat_order), 
             fill = mean_prop)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90, hjust =1, vjust = 0.5))
```

### Pairwise wilcoxon

```{r}
run_wilcox_all <- function(prop_data) {
  
  prop_data_group <- prop_data[["niche"]] %>%
    unique() %>%
    set_names()
  
  map(prop_data_group, function(g) {
    
    test_data <- prop_data %>%
      mutate(test_group = ifelse(niche == g,
                                 "target", "rest"))
      
    wilcox.test(mean_prop ~ test_group, 
                data = test_data,
                alternative = "less") %>%
      broom::tidy()
  }) %>% enframe("patient_group") %>%
    unnest()
    
}
```

```{r}
wilcox_res <- cell_info %>%
  group_by(cell_type) %>%
  nest() %>%
  mutate(wlcx_res = map(data, run_wilcox_all)) %>%
  select(wlcx_res) %>%
  unnest()
```

```{r}
wilcox_res %>%
  dplyr::filter(p.value < 0.05) %>%
  print(n = 50)
```

```{r, fig.height=4, fig.width=8}
wilcox_res %>%
  mutate(pcorr = p.adjust(p.value)) %>%
  mutate(significant = ifelse(pcorr < 0.15, "yes", "no")) %>%
  ggplot(aes(x = patient_group, y = cell_type, size = -log10(pcorr), color = significant)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust =1, vjust = 0.5)) +
  scale_color_discrete(type = c("black", "gold"))
```









